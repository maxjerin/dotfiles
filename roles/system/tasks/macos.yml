---
# macOS tasks are now split into logical files for better organization
# See roles/system/tasks/macos/ directory

- name: Load SSH configuration
  include_tasks:
    file: macos/ssh.yml
  tags:
    - macos
    - macos_ssh

- name: Load macOS system settings
  include_tasks:
    file: macos/settings.yml
  tags:
    - macos
    - macos_settings

- name: Load Homebrew installation tasks
  include_tasks:
    file: macos/homebrew.yml
  tags:
    - macos
    - macos_homebrew

- name: Load default application handlers
  include_tasks:
    file: macos/defaults.yml
  tags:
    - macos
    - macos_defaults

- name: Load Mac App Store installation tasks
  include_tasks:
    file: macos/mas.yml
  tags:
    - macos
    - macos_mas

- name: Load repository configuration
  include_tasks:
    file: macos/repos.yml
  tags:
    - macos
    - macos_repos

- name: Set Arc as default browser (http/https) using duti
  ansible.builtin.shell: |
    if ! command -v duti >/dev/null 2>&1; then
      echo "duti not installed; skipping default browser configuration"
      exit 0
    fi

    ARC_PLIST="/Applications/Arc.app/Contents/Info.plist"
    ARC_BUNDLE_ID=""
    if [ -f "$ARC_PLIST" ]; then
      ARC_BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$ARC_PLIST" 2>/dev/null || echo "")
    fi

    # Try known bundle IDs if plist lookup failed
    if [ -z "${ARC_BUNDLE_ID:-}" ]; then
      # Try common Arc bundle IDs
      for bundle_id in "company.thebrowser.Browser" "company.thebrowser.Arc" "com.thebrowser.Arc"; do
        if duti -s "${bundle_id}" http 2>/dev/null; then
          ARC_BUNDLE_ID="${bundle_id}"
          break
        fi
      done
    fi

    if [ -z "${ARC_BUNDLE_ID:-}" ]; then
      echo "Could not determine Arc bundle ID; skipping default browser configuration"
      echo "You may need to set Arc as default browser manually in System Settings"
      exit 0
    fi

    echo "Setting default handler for http/https to ${ARC_BUNDLE_ID}"
    duti -s "${ARC_BUNDLE_ID}" http 2>/dev/null || echo "Warning: Failed to set http handler (may require manual configuration)"
    duti -s "${ARC_BUNDLE_ID}" https 2>/dev/null || echo "Warning: Failed to set https handler (may require manual configuration)"
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  register: set_arc_default_browser_result

- name: Set Warp as default SSH handler using duti
  ansible.builtin.shell: |
    set -e
    if ! command -v duti >/dev/null 2>&1; then
      echo "duti not installed; skipping default SSH handler configuration"
      exit 0
    fi

    WARP_PLIST="/Applications/Warp.app/Contents/Info.plist"
    if [ -f "$WARP_PLIST" ]; then
      WARP_BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$WARP_PLIST" 2>/dev/null || echo "")
    fi

    # Fallback to common bundle id if plist lookup failed
    if [ -z "${WARP_BUNDLE_ID:-}" ]; then
      WARP_BUNDLE_ID="dev.warp.Warp"
    fi

    echo "Setting default handler for ssh to ${WARP_BUNDLE_ID}"
    duti -s "${WARP_BUNDLE_ID}" ssh
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  register: set_warp_default_ssh_result
