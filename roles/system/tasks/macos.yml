---
- name: Copy ssh config with 1Password link to ssh directory
  copy:
    src: macos_config
    dest: ~/.ssh/config

- name: Set macOS default settings
  community.general.osx_defaults:
    domain: "{{ item['domain'] }}"
    key: "{{ item['key'] }}"
    type: "{{ item['type'] | default(omit) }}"
    value: "{{ item['value'] }}"
  loop: "{{ defaults }}"
  tags:
    - macos
    - macos_settings

- name: Disable Spotlight Command+Space shortcut
  ansible.builtin.shell: |
    # Ensure the preferences file exists
    if [ ! -f ~/Library/Preferences/com.apple.symbolichotkeys.plist ]; then
      defaults read com.apple.symbolichotkeys > /dev/null 2>&1 || true
    fi

    # Method 1: Use PlistBuddy to disable Spotlight shortcut (key 64 = Command+Space)
    PLIST_FILE="$HOME/Library/Preferences/com.apple.symbolichotkeys.plist"

    # Check if key 64 exists, if not create it
    if ! /usr/libexec/PlistBuddy -c "Print :AppleSymbolicHotKeys:64" "$PLIST_FILE" >/dev/null 2>&1; then
      # Create the complete structure for key 64
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64 dict" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:enabled bool false" "$PLIST_FILE"
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value dict" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:type string standard" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters array" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters:0 integer 32" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters:1 integer 49" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters:2 integer 1048576" "$PLIST_FILE" 2>/dev/null || true
    else
      # Key exists, just disable it
      /usr/libexec/PlistBuddy -c "Set :AppleSymbolicHotKeys:64:enabled bool false" "$PLIST_FILE"
    fi

    # Method 2: Also use defaults write as a backup (more reliable)
    defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 64 "{enabled = 0; value = { parameters = (32, 49, 1048576); type = 'standard'; }; }" 2>/dev/null || true

    # Method 3: Try to change Spotlight shortcut to something else to force it off
    # Change it to Command+Option+Space (which is less likely to conflict)
    defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 65 "{enabled = 1; value = { parameters = (32, 49, 1179648); type = 'standard'; }; }" 2>/dev/null || true

    # Restart Dock and SystemUIServer to apply changes
    killall Dock 2>/dev/null || true
    killall SystemUIServer 2>/dev/null || true

    echo "Spotlight Command+Space shortcut disabled"
    echo "NOTE: You may need to manually uncheck Spotlight in System Settings → Keyboard → Keyboard Shortcuts"
  tags:
    - macos
    - macos_settings
  changed_when: true
  register: disable_spotlight_result

- name: Configure Raycast to use Command+Space hotkey
  ansible.builtin.shell: |
    # Set Raycast hotkey to Command+Space if Raycast is installed
    if [ -d "/Applications/Raycast.app" ]; then
      # Raycast uses "Command-49" format (49 is space key code, Command is modifier)
      # Set Raycast hotkey to Command+Space
      defaults write com.raycast.macos raycastGlobalHotkey "Command-49"
      defaults write com.raycast.macos initialSpotlightHotkey "Command-49"
      # Kill Raycast if running to apply changes (will restart automatically)
      killall Raycast 2>/dev/null || true
      echo "Raycast hotkey configured to Command+Space"
    else
      echo "Raycast not found, skipping hotkey configuration"
    fi
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  register: configure_raycast_result

- name: Disable Spotlight indexing and search results
  ansible.builtin.shell: |
    # Disable Spotlight indexing for all volumes
    sudo mdutil -i off / 2>/dev/null || true
    sudo mdutil -i off /System/Volumes/Data 2>/dev/null || true

    # Clear and erase existing Spotlight indexes
    sudo mdutil -E / 2>/dev/null || true
    sudo mdutil -E /System/Volumes/Data 2>/dev/null || true

    # Remove Spotlight index directories (more aggressive)
    sudo rm -rf /.Spotlight-V100 2>/dev/null || true
    sudo rm -rf /System/Volumes/Data/.Spotlight-V100 2>/dev/null || true

    # Disable indexing via defaults
    defaults write com.apple.Spotlight.plist indexingEnabled -bool false 2>/dev/null || true

    # Replace entire orderedItems array with all categories disabled
    # Using PlistBuddy to properly set the array
    PLIST_FILE="$HOME/Library/Preferences/com.apple.Spotlight.plist"

    # First, delete existing orderedItems if it exists
    /usr/libexec/PlistBuddy -c "Delete :orderedItems" "$PLIST_FILE" 2>/dev/null || true

    # Create new array with all categories disabled
    /usr/libexec/PlistBuddy -c "Add :orderedItems array" "$PLIST_FILE" 2>/dev/null || true

    # Add all categories as disabled
    CATEGORIES=(
      "APPLICATIONS" "BOOKMARKS" "CONTACT" "DIRECTORIES" "DOCUMENTS"
      "EVENT_TODO" "FONTS" "IMAGES" "MENU_CONVERSION" "MENU_DEFINITION"
      "MENU_EXPRESSION" "MENU_OTHER" "MENU_SPOTLIGHT_SUGGESTIONS" "MESSAGES"
      "MOVIES" "MUSIC" "PDF" "PRESENTATIONS" "SPREADSHEETS" "SYSTEM_PREFS"
      "SOURCE" "WEB_PAGES"
    )

    INDEX=0
    for category in "${CATEGORIES[@]}"; do
      /usr/libexec/PlistBuddy -c "Add :orderedItems:$INDEX dict" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :orderedItems:$INDEX:enabled integer 0" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :orderedItems:$INDEX:name string $category" "$PLIST_FILE" 2>/dev/null || true
      INDEX=$((INDEX + 1))
    done

    # Alternative: Use defaults write with proper array syntax
    defaults delete com.apple.Spotlight orderedItems 2>/dev/null || true
    defaults write com.apple.Spotlight orderedItems -array \
      '{enabled = 0; name = APPLICATIONS;}' \
      '{enabled = 0; name = BOOKMARKS;}' \
      '{enabled = 0; name = CONTACT;}' \
      '{enabled = 0; name = DIRECTORIES;}' \
      '{enabled = 0; name = DOCUMENTS;}' \
      '{enabled = 0; name = EVENT_TODO;}' \
      '{enabled = 0; name = FONTS;}' \
      '{enabled = 0; name = IMAGES;}' \
      '{enabled = 0; name = MENU_CONVERSION;}' \
      '{enabled = 0; name = MENU_DEFINITION;}' \
      '{enabled = 0; name = MENU_EXPRESSION;}' \
      '{enabled = 0; name = MENU_OTHER;}' \
      '{enabled = 0; name = MENU_SPOTLIGHT_SUGGESTIONS;}' \
      '{enabled = 0; name = MESSAGES;}' \
      '{enabled = 0; name = MOVIES;}' \
      '{enabled = 0; name = MUSIC;}' \
      '{enabled = 0; name = PDF;}' \
      '{enabled = 0; name = PRESENTATIONS;}' \
      '{enabled = 0; name = SPREADSHEETS;}' \
      '{enabled = 0; name = SYSTEM_PREFS;}' \
      '{enabled = 0; name = SOURCE;}' \
      '{enabled = 0; name = WEB_PAGES;}' 2>/dev/null || true

    # Disable Spotlight indexing service
    sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist 2>/dev/null || true

    # Restart SystemUIServer and kill Spotlight processes
    killall SystemUIServer 2>/dev/null || true
    killall Spotlight 2>/dev/null || true

    echo "Spotlight indexing and search results disabled"
    echo "NOTE: You may need to log out and back in for changes to take full effect"
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  become: true
  register: disable_spotlight_indexing_result

- name: Configure Dock with custom apps
  ansible.builtin.shell: |
    # Configure Dock with specific apps in specified order
    # Order: whatsapp, imessages, copilot money, slack, arc, vscode, warp, cursor, notion, imovie, music, reminders

    # Clear existing Dock apps
    defaults delete com.apple.dock persistent-apps 2>/dev/null || true

    # Use dockutil if available, otherwise use defaults write with PlistBuddy
    if command -v dockutil &> /dev/null; then
      # Remove all apps first
      dockutil --remove all --no-restart 2>/dev/null || true

      # Add apps in specified order
      dockutil --add "/Applications/WhatsApp.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Messages.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Copilot.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Slack.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Arc.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Visual Studio Code.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Warp.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Cursor.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Notion.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/iMovie.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Music.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Reminders.app" --no-restart 2>/dev/null || true

      echo "Dock configured using dockutil"
    else
      # Fallback: Use Python to create proper plist structure
      python3 << 'PYTHON_SCRIPT'
      import plistlib
      import os
      from pathlib import Path

      apps = [
          "/Applications/WhatsApp.app",
          "/Applications/Messages.app",
          "/Applications/Copilot.app",
          "/Applications/Slack.app",
          "/Applications/Arc.app",
          "/Applications/Visual Studio Code.app",
          "/Applications/Warp.app",
          "/Applications/Cursor.app",
          "/Applications/Notion.app",
          "/Applications/iMovie.app",
          "/Applications/Music.app",
          "/Applications/Reminders.app"
      ]

      persistent_apps = []
      for app_path in apps:
          if os.path.exists(app_path):
              app_url = f"file://{app_path}"
              tile_data = {
                  "tile-data": {
                      "file-data": {
                          "_CFURLString": app_url,
                          "_CFURLStringType": 0
                      }
                  },
                  "tile-type": "file-tile"
              }
              persistent_apps.append(tile_data)

      if persistent_apps:
          plist_path = Path.home() / "Library/Preferences/com.apple.dock.plist"
          try:
              # Read existing plist
              with open(plist_path, 'rb') as f:
                  plist = plistlib.load(f)

              # Update persistent-apps
              plist['persistent-apps'] = persistent_apps

              # Write back
              with open(plist_path, 'wb') as f:
                  plistlib.dump(plist, f)

              print("Dock configured with custom apps")
          except Exception as e:
              print(f"Error configuring Dock: {e}")
      PYTHON_SCRIPT
    fi

    # Restart Dock to apply changes
    killall Dock 2>/dev/null || true
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  register: configure_dock_result

- name: Add Homebrew taps
  community.general.homebrew_tap:
    name: "{{ item }}"
    state: present
  loop: "{{ homebrew['taps_macos'] }}"
  ignore_errors: true
  tags:
    - macos

- name: Install common Homebrew formulas
  community.general.homebrew:
    name: "{{ item }}"
  loop: "{{ homebrew['formulas_common'] }}"
  ignore_errors: true
  tags:
    - macos

- name: Install macOS-specific Homebrew formulas
  community.general.homebrew:
    name: "{{ item }}"
  loop: "{{ homebrew['formulas_macos'] }}"
  ignore_errors: true
  tags:
    - macos

- name: Install Homebrew casks (macOS GUI applications)
  community.general.homebrew_cask:
    name: "{{ item }}"
    accept_external_apps: true
  loop: "{{ homebrew['casks_macos_only'] }}"
  ignore_errors: true
  tags:
    - macos

# - name: Check Mac App Store authentication status
#   ansible.builtin.command: mas account
#   changed_when: false
#   failed_when: mas_account['rc'] not in [0,1]
#   register: mas_account
#   tags:
#     - macos

- name: Set Arc as default browser (http/https) using duti
  ansible.builtin.shell: |
    set -e
    if ! command -v duti >/dev/null 2>&1; then
      echo "duti not installed; skipping default browser configuration"
      exit 0
    fi

    ARC_PLIST="/Applications/Arc.app/Contents/Info.plist"
    if [ -f "$ARC_PLIST" ]; then
      ARC_BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$ARC_PLIST" 2>/dev/null || echo "")
    fi

    # Fallback to known bundle id if plist lookup failed
    if [ -z "${ARC_BUNDLE_ID:-}" ]; then
      ARC_BUNDLE_ID="company.thebrowser.Arc"
    fi

    echo "Setting default handler for http/https to ${ARC_BUNDLE_ID}"
    duti -s "${ARC_BUNDLE_ID}" http
    duti -s "${ARC_BUNDLE_ID}" https
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  register: set_arc_default_browser_result

- name: Set Warp as default SSH handler using duti
  ansible.builtin.shell: |
    set -e
    if ! command -v duti >/dev/null 2>&1; then
      echo "duti not installed; skipping default SSH handler configuration"
      exit 0
    fi

    WARP_PLIST="/Applications/Warp.app/Contents/Info.plist"
    if [ -f "$WARP_PLIST" ]; then
      WARP_BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$WARP_PLIST" 2>/dev/null || echo "")
    fi

    # Fallback to common bundle id if plist lookup failed
    if [ -z "${WARP_BUNDLE_ID:-}" ]; then
      WARP_BUNDLE_ID="dev.warp.Warp"
    fi

    echo "Setting default handler for ssh to ${WARP_BUNDLE_ID}"
    duti -s "${WARP_BUNDLE_ID}" ssh
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  register: set_warp_default_ssh_result

- name: Install apps
  ansible.builtin.command: "mas install {{ item }}"
  loop: "{{ homebrew['mas'] }}"
  tags:
    - macos

- name: Install repositories
  ansible.builtin.yum_repository:
    name: "{{ item['name'] }}"
    description: "{{ item['description'] }}"
    baseurl: "{{ item['baseurl'] | default(omit) }}"
    metalink: "{{ item['metalink'] | default(omit) }}"
    includepkgs: "{{ item['includepkgs'] | default(omit) }}"
    exclude: "{{ item['exclude'] | default(omit) }}"
    gpgcheck: "{{ item['gpgcheck'] | default(true) }}" # Remove this
    gpgkey: "{{ item['gpgkey'] }}"
    repo_gpgcheck: "{{ item['repo_gpgcheck'] | default(false) }}"
    skip_if_unavailable: "{{ item['skip_if_unavailable'] | default(true) }}"
  loop: "{{ repos }}"
  loop_control:
    label: "{{ item['name'] }}"
  become: true
  when: system_type in item['system_type']
  tags: repos
