---
# macOS tasks are now split into logical files for better organization
# See roles/system/tasks/macos/ directory

- name: Load SSH configuration
  include_tasks:
    file: macos/ssh.yml
  tags:
    - macos
    - macos_ssh

- name: Load macOS system settings
  include_tasks:
    file: macos/settings.yml
  tags:
    - macos
    - macos_settings

- name: Load Homebrew installation tasks
  include_tasks:
    file: macos/homebrew.yml
  tags:
    - macos
    - macos_homebrew

- name: Load default application handlers
  include_tasks:
    file: macos/defaults.yml
  tags:
    - macos
    - macos_defaults

- name: Load Mac App Store installation tasks
  include_tasks:
    file: macos/mas.yml
  tags:
    - macos
    - macos_mas

- name: Load repository configuration
  include_tasks:
    file: macos/repos.yml
  tags:
    - macos
    - macos_repos

- name: Configure Dock with custom apps
  ansible.builtin.shell: |
    # Configure Dock with specific apps in specified order
    # Order: whatsapp, imessages, copilot money, slack, arc, vscode, warp, cursor, notion, imovie, music, reminders

    # Clear existing Dock apps
    defaults delete com.apple.dock persistent-apps 2>/dev/null || true

    # Use dockutil if available, otherwise use defaults write with PlistBuddy
    if command -v dockutil &> /dev/null; then
      # Remove all apps first
      dockutil --remove all --no-restart 2>/dev/null || true

      # Add apps in specified order
      dockutil --add "/Applications/WhatsApp.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Messages.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Copilot.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Slack.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Arc.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Visual Studio Code.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Warp.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Cursor.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Notion.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/iMovie.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Music.app" --no-restart 2>/dev/null || true
      dockutil --add "/Applications/Reminders.app" --no-restart 2>/dev/null || true

      echo "Dock configured using dockutil"
    else
      # Fallback: Use Python to create proper plist structure
      python3 - <<'PYEOF'
        import plistlib
        import os
        from pathlib import Path

        apps = [
            '/Applications/WhatsApp.app',
            '/Applications/Messages.app',
            '/Applications/Copilot.app',
            '/Applications/Slack.app',
            '/Applications/Arc.app',
            '/Applications/Visual Studio Code.app',
            '/Applications/Warp.app',
            '/Applications/Cursor.app',
            '/Applications/Notion.app',
            '/Applications/iMovie.app',
            '/Applications/Music.app',
            '/Applications/Reminders.app'
        ]

        persistent_apps = []
        for app_path in apps:
            if os.path.exists(app_path):
                app_url = f'file://{app_path}'
                tile_data = {
                    'tile-data': {
                        'file-data': {
                            '_CFURLString': app_url,
                            '_CFURLStringType': 0
                        }
                    },
                    'tile-type': 'file-tile'
                }
                persistent_apps.append(tile_data)

        if persistent_apps:
            plist_path = Path.home() / 'Library/Preferences/com.apple.dock.plist'
            try:
                with open(plist_path, 'rb') as f:
                    plist = plistlib.load(f)
                plist['persistent-apps'] = persistent_apps
                with open(plist_path, 'wb') as f:
                    plistlib.dump(plist, f)
                print('Dock configured with custom apps')
            except Exception as e:
                print(f'Error configuring Dock: {e}')
      PYEOF
      fi

    # Restart Dock to apply changes
    killall Dock 2>/dev/null || true
  tags:
    - macos
    - macos_dock
