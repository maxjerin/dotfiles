---
- name: Copy ssh config with 1Password link to ssh directory
  copy:
    src: macos_config
    dest: ~/.ssh/config

- name: Set macOS default settings
  community.general.osx_defaults:
    domain: "{{ item['domain'] }}"
    key: "{{ item['key'] }}"
    type: "{{ item['type'] | default(omit) }}"
    value: "{{ item['value'] }}"
  loop: "{{ defaults }}"
  tags:
    - macos
    - macos_settings

- name: Disable Spotlight Command+Space shortcut
  ansible.builtin.shell: |
    # Ensure the preferences file exists
    if [ ! -f ~/Library/Preferences/com.apple.symbolichotkeys.plist ]; then
      defaults read com.apple.symbolichotkeys > /dev/null 2>&1 || true
    fi

    # Method 1: Use PlistBuddy to disable Spotlight shortcut (key 64 = Command+Space)
    PLIST_FILE="$HOME/Library/Preferences/com.apple.symbolichotkeys.plist"

    # Check if key 64 exists, if not create it
    if ! /usr/libexec/PlistBuddy -c "Print :AppleSymbolicHotKeys:64" "$PLIST_FILE" >/dev/null 2>&1; then
      # Create the complete structure for key 64
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64 dict" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:enabled bool false" "$PLIST_FILE"
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value dict" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:type string standard" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters array" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters:0 integer 32" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters:1 integer 49" "$PLIST_FILE" 2>/dev/null || true
      /usr/libexec/PlistBuddy -c "Add :AppleSymbolicHotKeys:64:value:parameters:2 integer 1048576" "$PLIST_FILE" 2>/dev/null || true
    else
      # Key exists, just disable it
      /usr/libexec/PlistBuddy -c "Set :AppleSymbolicHotKeys:64:enabled bool false" "$PLIST_FILE"
    fi

    # Method 2: Also use defaults write as a backup (more reliable)
    defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 64 "{enabled = 0; value = { parameters = (32, 49, 1048576); type = 'standard'; }; }" 2>/dev/null || true

    # Method 3: Try to change Spotlight shortcut to something else to force it off
    # Change it to Command+Option+Space (which is less likely to conflict)
    defaults write com.apple.symbolichotkeys AppleSymbolicHotKeys -dict-add 65 "{enabled = 1; value = { parameters = (32, 49, 1179648); type = 'standard'; }; }" 2>/dev/null || true

    # Restart Dock and SystemUIServer to apply changes
    killall Dock 2>/dev/null || true
    killall SystemUIServer 2>/dev/null || true

    echo "Spotlight Command+Space shortcut disabled"
    echo "NOTE: You may need to manually uncheck Spotlight in System Settings → Keyboard → Keyboard Shortcuts"
  tags:
    - macos
    - macos_settings
  changed_when: true
  register: disable_spotlight_result

- name: Configure Raycast to use Command+Space hotkey
  ansible.builtin.shell: |
    # Set Raycast hotkey to Command+Space if Raycast is installed
    if [ -d "/Applications/Raycast.app" ]; then
      # Raycast uses "Command-49" format (49 is space key code, Command is modifier)
      # Set Raycast hotkey to Command+Space
      defaults write com.raycast.macos raycastGlobalHotkey "Command-49"
      defaults write com.raycast.macos initialSpotlightHotkey "Command-49"
      # Kill Raycast if running to apply changes (will restart automatically)
      killall Raycast 2>/dev/null || true
      echo "Raycast hotkey configured to Command+Space"
    else
      echo "Raycast not found, skipping hotkey configuration"
    fi
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  register: configure_raycast_result

- name: Disable Spotlight indexing and search results
  ansible.builtin.shell: |
    # Disable Spotlight indexing for all volumes
    # This stops Spotlight from indexing files and using CPU/disk resources
    sudo mdutil -i off / 2>/dev/null || true
    sudo mdutil -i off /System/Volumes/Data 2>/dev/null || true

    # Clear existing Spotlight index
    sudo mdutil -E / 2>/dev/null || true
    sudo mdutil -E /System/Volumes/Data 2>/dev/null || true

    # Disable indexing via defaults
    defaults write com.apple.Spotlight.plist indexingEnabled -bool false 2>/dev/null || true

    # Disable all Spotlight search result categories
    # This prevents Spotlight from showing any search results
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "APPLICATIONS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "BOOKMARKS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "CONTACT";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "DIRECTORIES";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "DOCUMENTS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "EVENT_TODO";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "FONTS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "IMAGES";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MENU_CONVERSION";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MENU_DEFINITION";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MENU_EXPRESSION";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MENU_OTHER";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MENU_SPOTLIGHT_SUGGESTIONS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MESSAGES";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MOVIES";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "MUSIC";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "PDF";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "PRESENTATIONS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "SPREADSHEETS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "SYSTEM_PREFS";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "SOURCE";}'
    defaults write com.apple.Spotlight orderedItems -array-add '{enabled = 0; name = "WEB_PAGES";}'

    # Disable Spotlight indexing service
    sudo launchctl unload -w /System/Library/LaunchDaemons/com.apple.metadata.mds.plist 2>/dev/null || true

    # Restart SystemUIServer to apply changes
    killall SystemUIServer 2>/dev/null || true

    echo "Spotlight indexing and search results disabled"
  tags:
    - macos
    - macos_settings
  changed_when: true
  ignore_errors: true
  become: true
  register: disable_spotlight_indexing_result

- name: Add Homebrew taps
  community.general.homebrew_tap:
    name: "{{ item }}"
    state: present
  loop: "{{ homebrew['taps_macos'] }}"
  ignore_errors: true
  tags:
    - macos

- name: Install common Homebrew formulas
  community.general.homebrew:
    name: "{{ item }}"
  loop: "{{ homebrew['formulas_common'] }}"
  ignore_errors: true
  tags:
    - macos

- name: Install macOS-specific Homebrew formulas
  community.general.homebrew:
    name: "{{ item }}"
  loop: "{{ homebrew['formulas_macos'] }}"
  ignore_errors: true
  tags:
    - macos

- name: Install Homebrew casks (macOS GUI applications)
  community.general.homebrew_cask:
    name: "{{ item }}"
    accept_external_apps: true
  loop: "{{ homebrew['casks_macos_only'] }}"
  ignore_errors: true
  tags:
    - macos

# - name: Check Mac App Store authentication status
#   ansible.builtin.command: mas account
#   changed_when: false
#   failed_when: mas_account['rc'] not in [0,1]
#   register: mas_account
#   tags:
#     - macos

- name: Install apps
  ansible.builtin.command: "mas install {{ item }}"
  loop: "{{ homebrew['mas'] }}"
  tags:
    - macos

- name: Install repositories
  ansible.builtin.yum_repository:
    name: "{{ item['name'] }}"
    description: "{{ item['description'] }}"
    baseurl: "{{ item['baseurl'] | default(omit) }}"
    metalink: "{{ item['metalink'] | default(omit) }}"
    includepkgs: "{{ item['includepkgs'] | default(omit) }}"
    exclude: "{{ item['exclude'] | default(omit) }}"
    gpgcheck: "{{ item['gpgcheck'] | default(true) }}" # Remove this
    gpgkey: "{{ item['gpgkey'] }}"
    repo_gpgcheck: "{{ item['repo_gpgcheck'] | default(false) }}"
    skip_if_unavailable: "{{ item['skip_if_unavailable'] | default(true) }}"
  loop: "{{ repos }}"
  loop_control:
    label: "{{ item['name'] }}"
  become: true
  when: system_type in item['system_type']
  tags: repos
